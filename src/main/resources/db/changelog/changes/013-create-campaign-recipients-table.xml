<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <changeSet id="013-create-campaign-recipients-table" author="openmailer">
        <createTable tableName="campaign_recipients">
            <column name="id" type="BIGSERIAL" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>

            <column name="campaign_id" type="BIGINT">
                <constraints nullable="false" foreignKeyName="fk_recipients_campaign" references="email_campaigns(id)"
                             onDelete="CASCADE"/>
            </column>

            <column name="contact_id" type="BIGINT">
                <constraints nullable="false" foreignKeyName="fk_recipients_contact" references="contacts(id)"
                             onDelete="CASCADE"/>
            </column>

            <column name="status" type="VARCHAR(50)" defaultValue="PENDING"/>

            <!-- Timestamps -->
            <column name="sent_at" type="TIMESTAMP"/>
            <column name="delivered_at" type="TIMESTAMP"/>
            <column name="opened_at" type="TIMESTAMP"/>
            <column name="clicked_at" type="TIMESTAMP"/>
            <column name="bounced_at" type="TIMESTAMP"/>
            <column name="complained_at" type="TIMESTAMP"/>

            <!-- Engagement tracking -->
            <column name="open_count" type="INT" defaultValueNumeric="0"/>
            <column name="click_count" type="INT" defaultValueNumeric="0"/>

            <!-- Error handling -->
            <column name="error_message" type="TEXT"/>
            <column name="retry_count" type="INT" defaultValueNumeric="0"/>

            <!-- Tracking identifier -->
            <column name="tracking_id" type="VARCHAR(255)">
                <constraints unique="true"/>
            </column>

            <!-- Timestamps -->
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Indexes -->
        <createIndex indexName="idx_campaign_recipients_campaign" tableName="campaign_recipients">
            <column name="campaign_id"/>
        </createIndex>

        <createIndex indexName="idx_campaign_recipients_contact" tableName="campaign_recipients">
            <column name="contact_id"/>
        </createIndex>

        <createIndex indexName="idx_campaign_recipients_status" tableName="campaign_recipients">
            <column name="status"/>
        </createIndex>

        <createIndex indexName="idx_campaign_recipients_tracking" tableName="campaign_recipients">
            <column name="tracking_id"/>
        </createIndex>

        <!-- Unique constraint for campaign-contact combination -->
        <addUniqueConstraint tableName="campaign_recipients"
                           columnNames="campaign_id, contact_id"
                           constraintName="unique_campaign_contact"/>
    </changeSet>

</databaseChangeLog>
